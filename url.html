<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Base URL + Values Manager</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
  .entry { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 5px; background: #fff; }
  .entry-header { display: flex; justify-content: space-between; align-items: center; }
  .entry-title { font-weight: bold; font-size: 1.1em; }
  .url-base { font-family: monospace; margin-top: 4px; margin-bottom: 10px; }
  .values-list { margin-left: 0; padding-left: 0; list-style: none; }
  .value-item { display: flex; align-items: center; margin-bottom: 6px; gap: 4px; }
  .value-link { text-decoration: none; color: blue; word-break: break-all; font-family: monospace; }
  .comment { font-size: 0.9em; color: #555; margin-left: 6px; font-style: italic; }
  button { margin-left: 4px; }
  label { display: block; margin: 8px 0 4px; }
  input[type="text"] { width: 100%; padding: 6px; box-sizing: border-box; }
  .controls { margin-top: 10px; }
</style>
<style>
input[type="color"],
input[type="date"],
input[type="datetime"],
input[type="datetime-local"],
input[type="email"],
input[type="month"],
input[type="number"],
input[type="password"],
input[type="search"],
input[type="tel"],
input[type="text"],
input[type="time"],
input[type="url"],
input[type="week"],
select:focus,
textarea {
  font-size: 16px;
}
</style>
</head>
<body>

<h1>Base URL + Values Manager</h1>

<section>
  <h2>Add New Entry</h2>
  <label for="titleInput">Title:</label>
  <input id="titleInput" type="text" placeholder="Entry title" />
  
  <label for="baseInput">Base URL (include &lt;&lt;V&gt;&gt; placeholder):</label>
  <input id="baseInput" type="text" placeholder="e.g. https://example.com/search?q=<<V>>" />
  
  <label for="valuesInput">Values (comma-separated):</label>
  <input id="valuesInput" type="text" placeholder="e.g. apple, banana, cherry" style="margin-bottom: 10px"/>
  
  <button onclick="addEntry()">Add Entry</button>
  <button onclick="exportEntries()">Export Entries</button>
  <input type="file" id="importFile" accept=".json,.charlie" onchange="importEntries(event)" />
</section>

<hr/>

<section>
  <h2>Saved Entries</h2>
  <div id="entriesContainer"></div>
</section>

<script>
  function reverseString(str){
    return str.split('').reverse().join('');
  }
  
  let entries = JSON.parse(localStorage.getItem('baseUrlEntries') || '{}');

  // Ensure old data format gets converted
  function normalizeData() {
    for (const key in entries) {
      if (Array.isArray(entries[key].values)) {
        entries[key].values = entries[key].values.map(v => {
          if (typeof v === 'string') {
            return { val: v, comment: '' };
          }
          return v;
        });
      }
    }
  }

  function saveEntries() {
    localStorage.setItem('baseUrlEntries', JSON.stringify(entries));
  }

  function renderEntries() {
    normalizeData();
    const container = document.getElementById('entriesContainer');
    container.innerHTML = '';

    for (const [title, entry] of Object.entries(entries)) {
      const div = document.createElement('div');
      div.className = 'entry';

      const header = document.createElement('div');
      header.className = 'entry-header';

      const titleEl = document.createElement('div');
      titleEl.className = 'entry-title';
      titleEl.textContent = title;
      header.appendChild(titleEl);

      const btnContainer = document.createElement('div');

      const openAllBtn = document.createElement('button');
      openAllBtn.textContent = 'Open All';
      openAllBtn.onclick = () => {
        entry.values.forEach(v => {
          const url = entry.base.replace('<<V>>', v.val);
          window.open(url, '_blank', 'noopener,noreferrer');
        });
      };
      btnContainer.appendChild(openAllBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.onclick = () => {
        if (confirm(`Are you sure you want to delete entry "${title}"?`)) {
          delete entries[title];
          saveEntries();
          renderEntries();
        }
      };
      btnContainer.appendChild(deleteBtn);

      header.appendChild(btnContainer);
      div.appendChild(header);

      const baseUrlEl = document.createElement('div');
      baseUrlEl.className = 'url-base';
      baseUrlEl.textContent = 'Base URL: ' + entry.base;
      div.appendChild(baseUrlEl);

      const valuesList = document.createElement('ul');
      valuesList.className = 'values-list';

      entry.values.forEach((obj, i) => {
        const li = document.createElement('li');
        li.className = 'value-item';

        const a = document.createElement('a');
        a.href = entry.base.replace('<<V>>', obj.val);
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = obj.val;
        a.className = 'value-link';
        li.appendChild(a);

        if (obj.comment) {
          const cmt = document.createElement('span');
          cmt.className = 'comment';
          cmt.textContent = `(${obj.comment})`;
          li.appendChild(cmt);
        }

        const editCmtBtn = document.createElement('button');
        editCmtBtn.textContent = 'Comment';
        editCmtBtn.onclick = () => {
          const newComment = prompt(`Edit comment for "${obj.val}":`, obj.comment || '');
          if (newComment !== null) {
            obj.comment = newComment.trim();
            saveEntries();
            renderEntries();
          }
        };
        li.appendChild(editCmtBtn);

        const removeValBtn = document.createElement('button');
        removeValBtn.textContent = 'X';
        removeValBtn.title = 'Remove this value';
        removeValBtn.onclick = () => {
          if (confirm(`Are you sure you want to delete "${obj.val}"?`)) {
            entry.values.splice(i, 1);
            saveEntries();
            renderEntries();
          }
        };
        li.appendChild(removeValBtn);

        valuesList.appendChild(li);
      });
      div.appendChild(valuesList);

      const addValueContainer = document.createElement('div');
      addValueContainer.className = 'controls';

      const addValueInput = document.createElement('input');
      addValueInput.type = 'text';
      addValueInput.placeholder = 'Add new value...';
      addValueInput.style.width = '50%';
      addValueContainer.appendChild(addValueInput);

      const addCommentInput = document.createElement('input');
      addCommentInput.type = 'text';
      addCommentInput.placeholder = 'Optional comment...';
      addCommentInput.style.width = '40%';
      addValueContainer.appendChild(addCommentInput);

      const addValueBtn = document.createElement('button');
      addValueBtn.textContent = 'Add Value';
      addValueBtn.onclick = () => {
        const val = addValueInput.value.trim();
        if (!val) return alert('Please enter a value.');
        entry.values.push({ val, comment: addCommentInput.value.trim() });
        saveEntries();
        renderEntries();
      };
      addValueContainer.appendChild(addValueBtn);

      div.appendChild(addValueContainer);

      container.appendChild(div);
    }
  }

  function addEntry() {
    const title = document.getElementById('titleInput').value.trim();
    const base = document.getElementById('baseInput').value.trim();
    let valuesRaw = document.getElementById('valuesInput').value.trim();

    if (!title) return alert('Please enter a title.');
    if (entries[title]) return alert('Entry under that title already exists.');
    if (!base || !base.includes('<<V>>')) return alert('Base URL must include the <<V>> placeholder.');
    if (!valuesRaw) valuesRaw = '';

    const values = valuesRaw.split(',').map(v => v.trim()).filter(v => v).map(v => ({ val: v, comment: '' }));

    entries[title] = { base, values };
    saveEntries();
    renderEntries();

    document.getElementById('titleInput').value = '';
    document.getElementById('baseInput').value = '';
    document.getElementById('valuesInput').value = '';
  }

function exportEntries() {
  const payload = reverseString(JSON.stringify(entries));
  const fileBlob = new Blob([payload], { type: 'application/octet-stream' });
  const fileUrl = URL.createObjectURL(fileBlob);

  const html = `<!doctype html>
<meta charset="utf-8">
<title>save.charlie</title>
<body style="font-family:system-ui, -apple-system, Roboto, Arial; padding:24px">
  <h2>Download save.charlie</h2>
  <p>If the file doesn't start automatically, click the link below to download it:</p>
  <a id="dl" href="${fileUrl}" download="save.charlie">Download save.charlie</a>
  <p style="margin-top:1rem;color:#666;font-size:0.9rem">Close this tab after downloading.</p>
</body>`;

  const htmlBlob = new Blob([html], { type: 'text/html' });
  const htmlUrl = URL.createObjectURL(htmlBlob);

  // Open the interstitial download page in a new tab
  window.open(htmlUrl, '_blank');

  // cleanup after a short while
  setTimeout(() => {
    URL.revokeObjectURL(fileUrl);
    URL.revokeObjectURL(htmlUrl);
  }, 120_000);
}


  function importEntries(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imported = JSON.parse(reverseString(e.target.result));
        if (typeof imported === 'object' && imported !== null) {
          entries = imported;
          saveEntries();
          renderEntries();
        } else {
          alert('Invalid file format.');
        }
      } catch {
        alert('Error parsing JSON file.');
      }
      event.target.value = '';
    };
    reader.readAsText(file);
  }

  normalizeData();
  renderEntries();
</script>

</body>
</html>
